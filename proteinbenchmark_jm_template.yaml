apiVersion: v1
kind: Pod
metadata:
  name: proteinbenchmark-jm
spec:
  affinity:
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
          - matchExpressions:
              # Require compatibility with CUDA 12.4
              # This version needs to be specified in the dockerfile `FROM` and
              # `RUN micromamba install` lines too
              # Check the version used by NRP nodes with:
              # kubectl get nodes -L nvidia.com/gpu.product,nvidia.com/cuda.runtime.major,nvidia.com/cuda.runtime.minor -l nvidia.com/gpu.product
              - key: nvidia.com/cuda.runtime.major
                operator: In
                values:
                  - "12"
              - key: nvidia.com/cuda.runtime.minor
                operator: In
                values:
                  - "4"
  containers:
    - name: proteinbenchmark-jm
      image: gitlab-registry.nrp-nautilus.io/josh.mitchell/proteinbenchmark-nrp:latest
      resources:
        limits:
          memory: "5Gi"
          cpu: "1"
          nvidia.com/gpu: 1
        requests:
          memory: "5Gi"
          cpu: "1"
          nvidia.com/gpu: 1
      volumeMounts:
        - mountPath: /opt/repo
          name: proteinbenchmark-jm-repos
        - name: rclone-config
          mountPath: /secrets/rclone.conf
          subPath: rclone.conf
        - name: openeye-license
          mountPath: /secrets/oe_license.txt
          subPath: oe_license.txt
      env:
        - name: OE_LICENSE
          value: /secrets/oe_license.txt
      command:
        - "/bin/sh"
        - "-c"
        - |
          set -euf -o pipefail
          git clone https://gitlab.nrp-nautilus.io/josh.mitchell/proteinbenchmark-nrp.git /opt/repo
          cd /opt/repo
          git checkout $SCRIPT_COMMIT
          mkdir /results
          rclone mount --daemon nrp-internal:proteinbenchmark-jm-bucket/results /results
          micromamba run -n base python $SCRIPT_PATH -f $FF -t $TARGET -r $REPLICA -w $WINDOW -o /results
  volumes:
    - name: proteinbenchmark-jm-repos
      emptyDir: {}
    - name: rclone-config
      secret:
        secretName: jm-rclone-config
    - name: openeye-license
      secret:
        secretName: oe-license-feb-2024
